"use strict";(function(n){n.ControlPanel=function(t){function s(n){var f=$(n.target).closest("li"),u=f.attr("id"),t;if(u){if(t=i.get_node(u),u.startsWith("ch_")){r.openChannel(t);return}if(t.data.channel===0){t=i.get_node(t.children[0]);r.openChannel(t);return}t.data.channel!==0&&i.toggle_node(t)}}var r=this,u,f,i,e,o;if(this.ppdata=null,this.basediv=t,this.userdiv="#"+t,u=this.basediv+"_body",this.treediv="#"+u,this.mkDiv=function(t,i){return i?"vint_port_"+t.getHub().getKey()+"_"+t.getHubPort():t instanceof n.Connection?"conn_"+this.basediv+"_"+t.id:t instanceof n.Phidget?t.getIsChannel()?"ch_"+this.basediv+"_"+t.getKey():"dev_"+this.basediv+"_"+t.getKey():void 0},this.mkDialogDiv=function(n,t){return this.basediv+"_"+n.getKey()+t},this.showOrHideVintPortDevices=function(n){var r=!1,u,t;for(u in n.children)if(t=i.get_node(n.children[u]),!t.data.obj.getIsHubPortDevice()){r=!0;break}r&&i.open_node(n);for(u in n.children)t=i.get_node(n.children[u]),t.data.obj.getIsHubPortDevice()&&(r&&!i.is_hidden(t)?i.hide_node(t):!r&&i.is_hidden(t)&&i.show_node(t))},!$.jstree)throw new Error("missing jquery jstree");$(this.userdiv).html('<div class="PhidgetControlPanel" id="'+this.basediv+'"><div class="PhidgetControlPanelHeader" id="'+this.basediv+'_header">Phidget22 JavaScript Control Panel<\/div><div class="PhidgetControlPanelBody" id="'+this.basediv+'_body"><\/div><div class="PhidgetControlPanelFooter" id="'+this.basediv+'_footer">Double Click to Launch UI<\/div><div id="'+this.basediv+'_dialogs"><\/div><div id="error_dialog"><\/div><\/div>');f={core:{check_callback:!0,dblclick_toggle:!1},plugins:["grid","contextmenu","sort"],contextmenu:{items:function(t){var f={},u,o={label:"Open",action:function(){r.openChannel(u)}},e;return t.id.startsWith("dev_")&&t.data&&t.data.obj&&t.data.obj.getDeviceClass()!==n.DeviceClass.VINT&&(f.setlabel={label:"Set Label...",action:function(){r.writeLabel(t)}}),t.id.startsWith("ch_")?(u=t,u.data&&u.data.obj&&(f.open=o)):t.data.channel===0?(u=i.get_node(t.children[0]),u.data&&u.data.obj&&(f.open=o)):t.id.startsWith("conn_")&&(e=n.Connections[t.id.substring(6+r.basediv.length)],e.connected?f.close={label:"Close",action:function(){this.close()}.bind(e)}:f.connect={label:"Connect",action:function(){this.connect()}.bind(e)}),f}},sort:function(n,t){var r=i.get_node(n),u=i.get_node(t);return r.text!==u.text?r.text>u.text?1:-1:r.data.serial!==u.data.serial?r.data.serial>u.data.serial?1:-1:r.data.channel!==u.data.channel?r.data.channel>u.data.channel?1:-1:this.get_text(n)>this.get_text(t)?1:-1},grid:{columns:[{header:"name"},{header:"SKU",value:"sku",width:120},{header:"Serial #",value:"serial",cellClass:"cell-right-align",width:75},{header:"Label",value:"label",width:120},{header:"Channel",value:"channel",cellClass:"cell-right-align",width:60},{header:"Version",value:"version",cellClass:"cell-right-align",width:60}]}};$(this.treediv).jstree(f);i=$(this.treediv).jstree(!0);$(this.treediv).dblclick(s);e=new n.Manager({onDeviceAttach:this.add.bind(this),onDeviceDetach:this.remove.bind(this),onAttach:this.add.bind(this),onDetach:this.remove.bind(this)});e.open();for(o in n.Connections)this.add(n.Connections[o]);n.onConnectionAdded=this.add.bind(this);n.onConnectionRemoved=this.remove.bind(this)};n.ControlPanel.prototype.writeLabel=function(t){var r=$(this.treediv).jstree(!0);for(var i in t.children)if(i=r.get_node(t.children[i]),i.data.obj instanceof n.Phidget&&i.data.obj.getIsChannel()){this.openChannel(i,!0);return}};n.ControlPanel.prototype.openChannel=function(t,i){var u=$(this.treediv).jstree(!0),r=t.data.obj;t.data.phidget||(t.data.phidget=r,r.onError=function(i,u){if(i==n.ErrorCode.BUSY||i==n.ErrorCode.ACCESS){r.close();delete t.data.phidget;$("#error_dialog").html("<p>Unable to open Phidget: "+u+"<p><p>This channel may be open elsewhere, or you may not have access.<p>");$("#error_dialog").dialog({title:"Unable to open",height:"auto",close:function(){$("#error_dialog").empty()}});return}console.error("Error event during open",u)},r.onAttach=function(n){this.render(n,i)}.bind(this),r.onDetach=function(n){n.isopen&&(typeof PhidgetPanel!="undefined"&&PhidgetPanel.toggle(n,this.mkDialogDiv(n,"")),delete t.data.phidget)}.bind(this),r.open(n.DEFAULT_TIMEOUT).catch(function(t){if(t.errorCode==n.ErrorCode.TIMEOUT){$("#error_dialog").html("<p>Unable to open Phidget because of a Timeout.<p>");$("#error_dialog").dialog({title:"Unable to open",height:"auto",close:function(){$("#error_dialog").empty()}});return}console.log("Open didn't complete: "+t.message)}))};n.ControlPanel.prototype.render=function(t,i){var f=this,e,s,r,h,o,u;if(this.ppdata===null){$.get("/controlpanel/PhidgetPanel.html",function(n){f.ppdata=n;f.render(t,i)});return}if(t.getAttached()){if(e=this.mkDialogDiv(t,""),o=$("#"+this.mkDialogDiv(t,"_phidgetpanel_content")),o.length){if(s=window[t.getChannelClassName().substring(7)+"Example"],!s)throw t.getChannelClassName().substring(7)+" Example not found";s.setup(t);PhidgetPanel.toggle(t,e);return}r=$("#"+this.mkDialogDiv(t,"_dialog"));h=this.ppdata.replace(/\$KEY/g,f.basediv+"_"+t.getKey());r.hide();r.html(h);PhidgetPanel.setup(t,e);PhidgetPanel.toggle(t,e);o=$("#"+this.mkDialogDiv(t,"_phidgetpanel_content"));u=t.getChannelClassName().substring(7);t.getChannelClass()===n.ChannelClass.DICTIONARY&&t.getDeviceSerialNumber()==2&&(u="ControlDictionary");i===!0&&(u="WriteLabel");$.get("/controlpanel/"+u+".html",function(n){if(t.getAttached()){n=n.replace(/\$KEY/g,e);o.empty();o.html(n);var s=window[u+"Example"];if(!s)throw u+" Example not found";s.setup(t);r.dialog({title:i?"Write Label":t.getChannelName(),autoOpen:!1,modal:!1,show:"blind",hide:"blind",width:s.width?s.width:"auto",height:"auto",autoResize:!0,open:function(){},close:function(){if(t.isopen){if(i){var n=$(f.treediv).jstree(!0),u=n.get_node(f.mkDiv(t.getParent()));u.data.label=t.getDeviceLabel();n.redraw_node(u)}t.close()}s.teardown&&s.teardown(t);r.empty()}});r.show();r.dialog("open")}})}};n.ControlPanel.prototype.add=function(t){var u=$(this.treediv).jstree(!0),a=this.mkDiv(t),i=u.get_node(a),e,v,h,c,y,p,r,o,l,w,s;if(i===!1)if(t instanceof n.Phidget)if(t.getIsChannel()){var f=t,i={id:this.mkDiv(f),text:f.getChannelName(),data:{channel:f.getChannel()}},s="#"+this.mkDiv(f.getParent());if(i=u.create_node(s,i,"last"))u.get_node(i).data.obj=f;else throw new Error("failed to add new node for channel: "+f);if(u.hide_icon(i),e=u.get_node(this.mkDiv(f.getParent())),e.children.length>1){for(v in e.children)h=u.get_node(e.children[v]),u.is_hidden(h)&&u.show_node(h);e.data.channel===0&&(e.data.channel="",u.redraw_node(e))}else u.hide_node(i);f.getChannelClass()===n.ChannelClass.HUB&&u.hide_node(i);c=this.mkDialogDiv(f,"_dialog");y=this.mkDialogDiv(f,"_dialog_content");$("#"+c).length===0&&(p=$("#"+this.basediv+"_dialogs"),p.append('<div id="'+c+'"><div id="'+y+'"><\/div><\/div>'))}else{r=t;i={id:a,text:r.getDeviceName(),data:{version:r.getDeviceVersion(),channel:0}};switch(r.device.type){case"VINT":i.icon="/controlpanel/style/vint.png";r.getIsHubPortDevice()||(i.data.sku=r.getDeviceSKU());break;case"MESH":case"USB":case"SPI":case"LIGHTNING":i.icon="/controlpanel/style/usb.png";i.data.serial=r.getDeviceSerialNumber();i.data.label=r.getDeviceLabel();i.data.sku=r.getDeviceSKU();break;case"VIRTUAL":i.icon="/controlpanel/style/virtual.png";i.data.serial=r.getDeviceSerialNumber();i.data.label=r.getDeviceLabel()}if(r.getDeviceClass()===n.DeviceClass.HUB&&(i.state={opened:!0}),r.getDeviceClass()===n.DeviceClass.VINT){if(o=this.mkDiv(r,!0),l=u.get_node(o),!l&&(s="#"+this.mkDiv(r.getParent()),w={id:o,text:"Port "+r.getHubPort(),icon:"/controlpanel/style/vint.png",data:{}},o=u.create_node(s,w,"last"),!o))throw new Error("failed to add new hub port node");if(i=u.create_node(o,i,"last"))u.get_node(i).data.obj=r;else throw new Error("failed to add new node for vint device: "+r);r.getIsHubPortDevice()&&u.hide_icon(i);this.showOrHideVintPortDevices(l)}else if(s=r.getParent()?"#"+this.mkDiv(r.getParent()):"#"+this.mkDiv(r.device.conn),i=u.create_node(s,i,"last"))u.get_node(i).data.obj=r;else throw new Error("failed to add new node for device: "+r);}else if(t instanceof n.Connection)var b=t,i={id:this.mkDiv(b),text:b.name,icon:"/controlpanel/style/net.png",state:{opened:!0},children:[],data:{}},i=u.create_node(null,i,"last")};n.ControlPanel.prototype.remove=function(t){var f,i;if(t instanceof n.Phidget){var r=$(this.treediv).jstree(!0),u=this.mkDiv(t),i=r.get_node(u);if(i===!1){console.log("unable to find node for:"+t+" ("+u+")");return}if(!r.is_leaf(i)){console.log("node "+t+" still has children!");return}if(i.data.phidget&&delete i.data.phidget,r.delete_node(i),!t.getIsChannel()&&t.getDeviceClass()===n.DeviceClass.VINT){if(f=this.mkDiv(t,!0),i=r.get_node(f),i===!1)return;r.is_leaf(i)?r.delete_node(i):this.showOrHideVintPortDevices(i)}}else if(t instanceof n.Connection){var r=$(this.treediv).jstree(!0),u=this.mkDiv(t),i=r.get_node(u);if(i===!1){console.log("unable to find node for:"+t+" ("+u+")");return}r.delete_node(i)}}})(window.phidget22);